generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  password          String?
  firstName         String
  lastName          String
  phoneNumber       String?
  role              UserRole  @default(BUYER)
  isEmailVerified   Boolean   @default(false)
  isPhoneVerified   Boolean   @default(false)
  profileImage      String?
  status            UserStatus @default(PENDING_VERIFICATION)
  lastLogin         DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  orders            Order[]
  carts             Cart[]
  addresses         Address[]
  reviews           Review[]
  
  @@index([email])
  @@index([role])
  @@index([status])
  @@map("users")
}

enum UserRole {
  BUYER
  SELLER
  ADMIN
  MODERATOR
  SUPPORT
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  BANNED
  PENDING_VERIFICATION
}

model Order {
  id                String        @id @default(uuid())
  orderNumber       String        @unique
  userId            String
  user              User          @relation(fields: [userId], references: [id])
  
  items             OrderItem[]
  
  subtotal          Float
  tax               Float
  shippingCost      Float
  discount          Float
  total             Float
  currency          String        @default("USD")
  
  status            OrderStatus   @default(PENDING)
  paymentStatus     PaymentStatus @default(PENDING)
  paymentMethod     String
  paymentId         String?
  
  shippingAddress   Json
  billingAddress    Json
  shippingMethod    String
  trackingNumber    String?
  estimatedDelivery DateTime?
  actualDelivery    DateTime?
  
  notes             String?
  metadata          Json?
  timeline          Json[]
  refunds           Json[]
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  @@index([userId])
  @@index([orderNumber])
  @@index([status])
  @@index([paymentStatus])
  @@index([createdAt])
  @@map("orders")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  RETURNED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  CAPTURED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

model OrderItem {
  id          String  @id @default(uuid())
  orderId     String
  order       Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  productId   String
  variantId   String?
  name        String
  sku         String
  quantity    Int
  price       Float
  discount    Float   @default(0)
  tax         Float   @default(0)
  total       Float
  image       String?
  attributes  Json?
  sellerId    String
  status      OrderItemStatus @default(PENDING)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([orderId])
  @@index([productId])
  @@index([sellerId])
  @@map("order_items")
}

enum OrderItemStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  RETURNED
  REFUNDED
}

model Cart {
  id        String     @id @default(uuid())
  userId    String     @unique
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  items     CartItem[]
  
  subtotal  Float      @default(0)
  tax       Float      @default(0)
  discount  Float      @default(0)
  total     Float      @default(0)
  
  couponCode String?
  metadata   Json?
  
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  
  @@index([userId])
  @@map("carts")
}

model CartItem {
  id            String   @id @default(uuid())
  cartId        String
  cart          Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  
  productId     String
  variantId     String?
  name          String
  sku           String
  quantity      Int
  price         Float
  image         String?
  attributes    Json?
  customization Json?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([cartId])
  @@index([productId])
  @@map("cart_items")
}

model Address {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  firstName   String
  lastName    String
  email       String
  phone       String
  street      String
  apartment   String?
  city        String
  state       String
  country     String
  postalCode  String
  isDefault   Boolean  @default(false)
  type        AddressType @default(SHIPPING)
  
  coordinates Json?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId])
  @@index([isDefault])
  @@map("addresses")
}

enum AddressType {
  SHIPPING
  BILLING
  BOTH
}

model Review {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  productId       String
  orderId         String?
  
  rating          Int
  title           String?
  comment         String?
  images          String[]
  wouldRecommend  Boolean  @default(true)
  
  isVerifiedPurchase Boolean @default(false)
  isPublished     Boolean  @default(true)
  
  helpfulCount    Int      @default(0)
  reportCount     Int      @default(0)
  
  sellerResponse  Json?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([userId])
  @@index([productId])
  @@index([rating])
  @@index([isPublished])
  @@map("reviews")
}

model Coupon {
  id              String       @id @default(uuid())
  code            String       @unique
  description     String?
  
  type            CouponType
  value           Float
  minPurchase     Float?
  maxDiscount     Float?
  
  usageLimit      Int?
  usageCount      Int          @default(0)
  perUserLimit    Int?
  
  applicableProducts String[]
  applicableCategories String[]
  excludedProducts String[]
  
  startDate       DateTime
  endDate         DateTime
  
  isActive        Boolean      @default(true)
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  @@index([code])
  @@index([isActive])
  @@index([startDate, endDate])
  @@map("coupons")
}

enum CouponType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_SHIPPING
  BUY_X_GET_Y
}

model Notification {
  id          String           @id @default(uuid())
  userId      String
  
  type        NotificationType
  title       String
  message     String
  data        Json?
  
  isRead      Boolean          @default(false)
  readAt      DateTime?
  
  channel     NotificationChannel @default(IN_APP)
  
  createdAt   DateTime         @default(now())
  
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  ORDER_PLACED
  ORDER_CONFIRMED
  ORDER_SHIPPED
  ORDER_DELIVERED
  ORDER_CANCELLED
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  REFUND_PROCESSED
  PRODUCT_BACK_IN_STOCK
  PRICE_DROP
  PROMOTION
  SYSTEM
}

enum NotificationChannel {
  IN_APP
  EMAIL
  SMS
  PUSH
}

model Wishlist {
  id          String   @id @default(uuid())
  userId      String
  name        String   @default("My Wishlist")
  description String?
  isPublic    Boolean  @default(false)
  
  items       WishlistItem[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId])
  @@map("wishlists")
}

model WishlistItem {
  id          String   @id @default(uuid())
  wishlistId  String
  wishlist    Wishlist @relation(fields: [wishlistId], references: [id], onDelete: Cascade)
  
  productId   String
  variantId   String?
  priority    Int      @default(0)
  notes       String?
  
  createdAt   DateTime @default(now())
  
  @@index([wishlistId])
  @@index([productId])
  @@map("wishlist_items")
}

model Session {
  id              String   @id @default(uuid())
  userId          String
  token           String   @unique
  refreshToken    String   @unique
  deviceInfo      Json
  ipAddress       String
  userAgent       String
  isActive        Boolean  @default(true)
  expiresAt       DateTime
  lastActivityAt  DateTime @default(now())
  createdAt       DateTime @default(now())
  
  @@index([userId])
  @@index([token])
  @@index([refreshToken])
  @@index([isActive])
  @@index([expiresAt])
  @@map("sessions")
}

model AuditLog {
  id          String   @id @default(uuid())
  userId      String?
  action      String
  resource    String
  resourceId  String?
  changes     Json?
  ipAddress   String?
  userAgent   String?
  metadata    Json?
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
  @@map("audit_logs")
}
